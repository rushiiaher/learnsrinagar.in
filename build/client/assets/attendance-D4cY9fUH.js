import{y as K,w as q,C as X,D as $,r as l,n as e}from"./components-CK9cG6NQ.js";import{t as S}from"./index-C8LQY8mX.js";import{B as o}from"./button-8oCJS-za.js";import{P as G,a as J,C as Q,b as U,c as W}from"./popover-x_GHSun8.js";import{S as Y,a as Z,b as ee,c as te,d as se}from"./select-DaRfL70x.js";import{u as ae,f as R,A as ne,a as le,b as ie,c as ce,d as re,e as de,g as oe,h as me,i as xe,j as ue}from"./index-BpyxCKkI.js";import{T as fe,a as pe,b as y,c as ge,d as he,e as T}from"./table-CRJQl8tI.js";import{a as z,C as M}from"./clock-XivtrA7v.js";import{c as je}from"./createLucideIcon-B7_wo53H.js";import{T as Ne}from"./trash-sprkVQyV.js";import{f as b}from"./format-CkqhGn1q.js";import"./chevron-right-6IEetazl.js";import"./index-Z0unZZUp.js";import"./index-B5_uNIGj.js";import"./index-DHMePj9W.js";import"./index-USjovnYi.js";import"./index-B4ME6Vf2.js";import"./index-B4BDNWcH.js";import"./index-DPB-uZjz.js";/**
 * @license lucide-react v0.503.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],I=je("circle-x",Se);function Oe(){const{attendance:C,students:D,classes:g,user:v}=K(),m=q(),A=X();$();const[x,E]=l.useState(new Date),[c,k]=l.useState(""),[u,w]=l.useState([]),[r,h]=l.useState({}),[F,j]=l.useState(!1),[i,B]=l.useState(null),[_,L]=l.useState([]),f=b(x,"yyyy-MM-dd");l.useEffect(()=>{m&&(m.success?S.success(m.message):S.error(m.message))},[m]),l.useEffect(()=>{if(c){const t=D.filter(s=>s.class_id.toString()===c);w(t)}else g.length>0?k(g[0].id.toString()):w([])},[c,D,g]),l.useEffect(()=>{const t={},s=C.filter(a=>typeof a.date=="string"?a.date.substring(0,10)===f:a.date instanceof Date?b(a.date,"yyyy-MM-dd")===f:!1);u.forEach(a=>{const n=s.find(p=>p.student_id===a.id&&p.class_id.toString()===c);n?t[a.id]={status:n.status,recordId:n.id}:t[a.id]={status:"not_marked",recordId:null}}),h(t)},[u,x,C,c,f]),l.useEffect(()=>{const t=u.map(s=>{var a,n;return{id:s.id,name:s.name,class_name:s.class_name,attendanceStatus:((a=r[s.id])==null?void 0:a.status)||"not_marked",recordId:((n=r[s.id])==null?void 0:n.recordId)||null}});L(t)},[u,r]);const N=(t,s)=>{const a=new FormData,n=r[t];n&&n.recordId?(a.append("_action","update"),a.append("id",n.recordId)):a.append("_action","create"),a.append("student_id",t),a.append("class_id",c),a.append("date",f),a.append("status",s),A(a,{method:"post"}),h(p=>({...p,[t]:{...p[t],status:s}}))},O=t=>{var a;const s=u.find(n=>n.id===t);(a=r[t])!=null&&a.recordId?(B({id:r[t].recordId,student_name:(s==null?void 0:s.name)||"Student",date:f}),j(!0)):S.error("No attendance record exists to delete")},H=()=>{const t=new FormData;t.append("_action","delete"),t.append("id",i.id),A(t,{method:"post"}),j(!1);const s=Object.keys(r).find(a=>r[a].recordId===i.id);s&&h(a=>({...a,[s]:{status:"not_marked",recordId:null}}))},V=t=>{switch(t){case"present":return e.jsxs("span",{className:"inline-flex items-center rounded-full bg-green-50 px-2 py-1 text-xs font-medium text-green-700",children:[e.jsx(z,{className:"mr-1 h-3 w-3"}),"Present"]});case"absent":return e.jsxs("span",{className:"inline-flex items-center rounded-full bg-red-50 px-2 py-1 text-xs font-medium text-red-700",children:[e.jsx(I,{className:"mr-1 h-3 w-3"}),"Absent"]});case"late":return e.jsxs("span",{className:"inline-flex items-center rounded-full bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-700",children:[e.jsx(M,{className:"mr-1 h-3 w-3"}),"Late"]});default:return e.jsx("span",{className:"inline-flex items-center rounded-full bg-gray-50 px-2 py-1 text-xs font-medium text-gray-700",children:"Not marked"})}},P=[{accessorKey:"name",header:"Student",cell:({row:t})=>e.jsx("div",{className:"text-center",children:t.original.name})},{accessorKey:"attendanceStatus",header:"Status",cell:({row:t})=>e.jsx("div",{className:"text-center",children:V(t.original.attendanceStatus)})},{id:"markAttendance",header:"Mark Attendance",cell:({row:t})=>e.jsx("div",{className:"flex justify-center space-x-2",children:v.role_name==="class_admin"?e.jsxs(e.Fragment,{children:[e.jsxs(o,{variant:t.original.attendanceStatus==="present"?"default":"outline",size:"sm",onClick:()=>N(t.original.id,"present"),children:[e.jsx(z,{className:"mr-1 size-4"}),"Present"]}),e.jsxs(o,{variant:t.original.attendanceStatus==="absent"?"default":"outline",size:"sm",onClick:()=>N(t.original.id,"absent"),children:[e.jsx(I,{className:"mr-1 size-4"}),"Absent"]}),e.jsxs(o,{variant:t.original.attendanceStatus==="late"?"default":"outline",size:"sm",onClick:()=>N(t.original.id,"late"),children:[e.jsx(M,{className:"mr-1 size-4"}),"Late"]})]}):e.jsx("span",{className:"text-sm text-gray-500 italic",children:"Only class admins can mark attendance"})})},{id:"actions",header:"Actions",cell:({row:t})=>e.jsx("div",{className:"flex justify-center gap-2",children:v.role_name==="class_admin"?e.jsx(o,{variant:"outline",size:"sm",onClick:()=>O(t.original.id),disabled:!t.original.recordId,children:e.jsx(Ne,{className:"size-4"})}):e.jsx("span",{className:"text-sm text-gray-500",children:"-"})})}],d=ae({data:_,columns:P,getCoreRowModel:ue(),getPaginationRowModel:xe(),initialState:{pagination:{pageSize:10}}});return e.jsxs("div",{className:"container mx-auto pb-10",children:[e.jsx("div",{className:"flex flex-col space-y-4 md:flex-row md:items-center md:justify-end mb-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"w-full",children:e.jsxs(Y,{value:c,onValueChange:k,children:[e.jsx(Z,{children:e.jsx(ee,{placeholder:"Select a class"})}),e.jsx(te,{children:g.map(t=>e.jsxs(se,{value:t.id.toString(),children:["Class ",t.name]},t.id))})]})}),e.jsx("div",{className:"w-full",children:e.jsxs(G,{children:[e.jsx(J,{asChild:!0,children:e.jsxs(o,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(Q,{className:"mr-2 h-4 w-4"}),x?b(x,"PPP"):"Select date"]})}),e.jsx(U,{className:"w-auto p-0",children:e.jsx(W,{mode:"single",selected:x,onSelect:E,initialFocus:!0})})]})})]})}),_.length>0?e.jsx("div",{className:"rounded-md border",children:e.jsxs(fe,{children:[e.jsx(pe,{children:d.getHeaderGroups().map(t=>e.jsx(y,{children:t.headers.map(s=>e.jsx(ge,{className:"text-center",children:s.isPlaceholder?null:R(s.column.columnDef.header,s.getContext())},s.id))},t.id))}),e.jsx(he,{children:d.getRowModel().rows.length?d.getRowModel().rows.map(t=>e.jsx(y,{"data-state":t.getIsSelected()&&"selected",children:t.getVisibleCells().map(s=>e.jsx(T,{className:"text-center",children:R(s.column.columnDef.cell,s.getContext())},s.id))},t.id)):e.jsx(y,{children:e.jsx(T,{colSpan:P.length,className:"h-24 text-center",children:"No students found."})})})]})}):e.jsx("div",{className:"rounded-md border p-8 text-center",children:c?"No students found in this class":"Please select a class"}),e.jsxs("div",{className:"flex items-center justify-end space-x-2 py-4",children:[e.jsx(o,{variant:"outline",size:"sm",onClick:()=>d.previousPage(),disabled:!d.getCanPreviousPage(),children:"Previous"}),e.jsx(o,{variant:"outline",size:"sm",onClick:()=>d.nextPage(),disabled:!d.getCanNextPage(),children:"Next"})]}),e.jsx(ne,{open:F,onOpenChange:j,children:e.jsxs(le,{children:[e.jsxs(ie,{className:"text-center",children:[e.jsx(ce,{children:"Delete Attendance Record"}),e.jsxs(re,{children:["Are you sure you want to delete this attendance record for"," ",e.jsx("strong",{children:i==null?void 0:i.student_name})," on"," ",(i==null?void 0:i.date)&&e.jsx("strong",{children:new Date(i.date).toLocaleDateString()}),"? This action cannot be undone."]})]}),e.jsxs(de,{className:"flex justify-end",children:[e.jsx(oe,{children:"Cancel"}),e.jsx(me,{onClick:H,className:"bg-destructive hover:bg-destructive/90",children:"Delete"})]})]})})]})}export{Oe as default};
